\documentclass[structabstract]{article}
\usepackage[varg]{txfonts}
% include packages
%\usepackage[dvips]{graphicx}
\usepackage{url}
\usepackage[breaklinks=true]{hyperref}
\usepackage{twoopt}
\usepackage{natbib}
\bibpunct{(}{)}{;}{a}{}{,}%% natbib format for A&A and ApJ
\usepackage{ctable}
\usepackage{multirow}
\usepackage[farskip=0pt]{subfig}

\setlength{\textwidth}{6.5in}
\setlength{\textheight}{9in}
\setlength{\topmargin}{-0.0625in}
\setlength{\oddsidemargin}{0in}
\setlength{\evensidemargin}{0in}
\setlength{\headheight}{0in}
\setlength{\headsep}{0in}
\setlength{\hoffset}{0in}
\setlength{\voffset}{0in}

\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%CUTCUTCUT

%\svnInfo $Id: bbs.tex 12951 2014-03-08 18:40:31Z dijkema $
\section[Factor: Facet Calibration for LOFAR]{Factor: Facet Calibration for
LOFAR\footnote{This section is maintained by David Rafferty
({\tt drafferty@hs.uni-hamburg.de}).}}
\label{factor}

Factor is a Python package that allows for the production of wide-field HBA
LOFAR images using the facet calibration scheme described in van Weeren et al.\
(2015). Note that Factor is still beta software. Please report bugs to
drafferty@hs.uni-hamburg.de.

To initialize your environment for Factor, users on CEP2 and CEP3 should run the
following commands:
\begin{verbatim}
use LofIm
source ~rafferty/init_factor
use Pythonlibs
\end{verbatim}

%-----------------------------------------------------------
\subsection{Usage}
\label{factor:usage}

Factor can be run from the command-line as follows:
\begin{verbatim}
Usage: factor <parset>
Options:
  --version   show program's version number and exit
  -h, --help  show this help message and exit
  -v          Verbose
\end{verbatim}
The parset specifies the parameters of the run. These are described in the next
sections.

%-----------------------------------------------------------
\subsection{Parset}
\label{factor:parset}

Below is an example parset that shows the available parameters. Note that the
parameters are grouped by sections (denoted by headings such as {\tt [global]},
{\tt [directions]}, etc.). Required parameters are noted.

\begin{verbatim}
[global]
# LOFAR installation root directories. If not given, they will be determined
# from the environment
lofarroot = /lofar/build/gnu_opt/installed
lofarpythonpath = /lofar/build/gnu_opt/installed/lib/python2.7/dist-packages

# Full path to Generic Pipeline root directory (required)
piperoot = /path/to/genericpipe/dir

# Full path to working dir - other paths are relative to this (required)
dir_working = /data/wdir

# Full path to directory containing selfcaled bands, will be scanned for all .MS
# and .ms files (required)
dir_ms = /data/bands

# Parmdb name for dir-indep. selfcal solutions (stored inside the input
# band measurement sets, so path should be relative to those). Default is
# instrument
parmdb_name = instrument_ap_smoothed

# Make final mosaic (default = True)
make_mosaic = False

# Use interactive mode (default = False)
interactive = False

# Use FT / FTW for all operations except initial subtraction (default = True)
use_ftw = True

# Choose imager to use (one of awimager, casapy, wsclean; default = awimager)
imager = awimager
imagerroot = /lofar/build/gnu_opt/installed


[directions]
# Full path to file containing calibrator directions. If not given, directions
# are selected internally using the flux and size cuts below
directions_file = /data/directions.txt

# Flux and size cuts for selecting directions internally (min flux, max size
# of a source, and max separation between sources below which they are grouped
# into one direction) (required if no directions_file is given)
flux_min_Jy = 0.1
size_max_arcmin = 3.0
separation_max_arcmin = 6.0

# The number of internally derived directions can be limited to a maximum number
# of directions if desired (default = all)
max_num = 50

# Total number of directions to process (default = all)
ndir = 10

# Grouping of directions into groups that are processed in parallel, defined as
# grouping:n_total_per_grouping. For example, groupings = 1:5, 4:0 means two
# groupings are used, with the first 5 directions put into groups of one (i.e.,
# each direction processed in series) and the rest of the directions divided
# into groups of 4 (i.e., 4 directions processed in parallel). Shuffling is done
# between neighboring groups to achieve the largest min separation. Default is
# one at a time (i.e., groupings = 1:0)
groupings = 1:5, 4:0


[cluster]
# Full path to cluster description file. Use clusterdesc_file = PBS to use the
# PBS / torque reserved nodes. If not given, the clusterdesc file for a single
# (i.e., local) node is used
clusterdesc_file = PBS

# Set distribute to True if the cluster has a distributed file system. Set to
# False if the cluster has a shared file system (the default)
distribute = False

# Maximum number of CPUs per node to use (default = all)
ncpu = 6


# MS-specific parameters (optional)
[ms1.ms]
init_skymodel = /data/ms1.sky
param1 = 123
param2 = 123

[ms2.ms]
init_skymodel = /data/ms2.sky
param1 = 123
param2 = 123
\end{verbatim}

%-----------------------------------------------------------
\subsection{Directions}
\label{factor:directions

The directions for which DDE calibration is performed can be selected
automatically by factor or specified in a file. The format of the file is as
follows:

\begin{verbatim}
# This is an example directions file for Factor.
#
# Directions should be sorted in order of reduction (e.g., bright to faint).
#
# Columns are defined as follows (in [] are optional parameters with their default values):
# Name (str), RA (float), DEC (float), [regionfile (str, default='')],
# [multiscale (bool, default=True)], [solint_amp (int, default=600)],
# [solint_ph (int, default=5)], [make_final_image (bool, default=True)],
# [cal_radius (float arcmin, default=3.0)]

calibrator_1, 111.11, 22.22, , , , , ,
calibrator_2, 222.22, 33.33, reg/cal2.reg, True, 600, 5, False, 4.5
calibrator_3, 333.33, 44.44, , True, 600, 5, ,
\end{verbatim}

This file should be specified in the parset file as the {\tt directions\_file}
parameter.

If no {\tt directions\_file} is given, the directions and their order of
processing are determined internally using the flux, size, and separation limits
specified in the parset as follows. First, the initial apparent-flux
clean-component (CC) skymodels (either given as input in the parset or generated
by the initial subtraction operation) are grouped by LSMTool using the
thresholding algorithm. These grouped patches of CCs are then filtered to meet
the specified flux and size limits ({\tt flux\_min\_Jy} and {\tt
size\_max\_arcmin}, respectively) and nearby patches are merged (specified by
{\tt separation\_max\_arcmin}). The resulting patches are then sorted by
apparent flux at the lowest available frequency (from bright to faint).

%Additionally, the direction centers used for tessellation can be automatically
%adjusted to avoid cases in which known sources (from the initial CC skymodels)
%fall too near to a facet boundary. This adjustment only affects the facet
%regions and does not affect the phase centers of the directions (specified in the
%{\tt directions\_file}). The amount of adjustment allowed is specified with the
%{\tt max\_adjustment\_arcmin} parameter (setting this parameter to 0 will disable
%adjustment).

Lastly, one can specify that more than one direction be processed in parallel
with the groupings parameter. Note that more than one node is required to
process directions in parallel (as little benefit will result from running
multiple directions in parallel on a single node). The groupings parameter
specifies the the grouping level (the number of directions to process
simultaneously) and the total number of directions at each grouping level. For
example, {\tt groupings = 1:5, 4:0} means two groupings are used, with the first
5 directions put into groups of one (i.e., each direction is processed in
series) and the rest of the directions divided into groups of 4 (i.e., 4
directions processed in parallel). Shuffling is done between neighboring groups
to achieve the largest minimum separation between directions in the groups. This
sorting attempts to minimize the effects that any artifacts from the
simultaneously processed directions have on one another.


%-----------------------------------------------------------
\subsection{Parallelization}
\label{factor:parallel}

Factor has been designed to run as much as possible in a parallel manner. To
this end, support is present for distributing the reduction over nodes of a
compute cluster and over the processors of a single computer.

To use Factor on a single computer, no setup is necessary beyond specifying the
maximum number of CPUs to use.

To use factor on multiple nodes of a compute cluster, the required setup depends
on the cluster layout (distributed vs. shared file system) and scheduling system
(if any).

\subsubsection{Torque / PBS scheduler}
For use on a compute cluster that uses torque and PBS, set {\tt clusterdesc =
PBS}. Factor will then automatically determine the nodes for which you have a
PBS reservation and use them.

\subsubsection{Shared file system}
Factor works by default on a compute cluster with a shared file system.

\subsubsection{Distributed file system}
For use on a cluster with a distributed file system (such as CEP2 and CEP3), set
{\tt distribute = True}. Factor will then synchronize files between the
available nodes. Note that all data will be mirrored on each node, so one must
ensure that all nodes have sufficient disk space. Additionally, the local disk
must have the same name on each node.


%-----------------------------------------------------------
\subsection{Resuming}
\label{factor:resuming}

Due to the potentially long run times and the consequent non-negligible chance
of some unforeseen failure occurring, Factor has been designed to allow easy
resumption of a reduction from a saved state and will skip over any steps that
were successfully completed previously. In this way, one can quickly resume a
reduction that was halted (either by the user or due to some problem) by simply
re-running Factor with the same parset.

For example, one can specify that only the first 5 directions be processed.
Once these directions are done, Factor will exit. One can then alter the parset
and specify that 10 directions should be done. Upon restarting, Factor will skip
over the first 5 directions and start with the 6th one (and ending with the 10th
one).


%-----------------------------------------------------------
\subsection{Structure}
\label{factor:structure}

Factor is structured based on operations and actions. An operation is composed
of a sequence of actions. For example, the initial subtraction operation
(denoted InitSubtract) performs the following actions: image at high resolution,
make a sky model, subtract the sky model, average, image and low resolution,
make another sky model, and finally subtract the second sky model. Operations
divide the reduction into logical groupings of actions as follows.

\begin{description}
\item[InitSubtract] Performs the initial imaging and subtraction of sources to
create ``source-free'' datasets. This operation may be skipped if sky models are
specified for each band in the parset and the {\tt SUBTRACTED\_DATA\_ALL} column
is present in all the bands.
\item[FacetAddCal] For each direction, the calibrator source is added to the
``source-free'' datasets. The data are then phase shifted to the appropriate
coordinates.
\item[FacetSetup] The direction-independent calibration is applied, and the
bands are concatenated and averaged.
\item[FacetSelfcal] Selfcalibration is performed on one or more directions,
using two rounds of phase-only calibration followed by two rounds of fast-phase
and slow-amplitude calibration.
\item[FacetAddAll] For each direction, all sources in the facet are added to the
``source-free'' datasets. The data are then phase shifted to the appropriate
coordinates.
\item[FacetImage] The direction-dependent calibration is applied, and the
bands are concatenated and averaged. The entire facet is then imaged, producing
a final model of the facet sources.
\item[FacetSubAll] The final model is subtracted, producing improved ``source-
free'' datasets.
\end{description}

The facet operations are repeated for each direction. Some operations, such as
the FacetSelfcal operation, can run on multiple directions simultaneously.

After each action finishes, the saved state is updated, allowing for resumption
of steps at the granularity of the actions in a given operation.

\end{document}
